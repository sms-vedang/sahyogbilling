<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sahyog Medical - Billing</title>
    <!-- Removed Tailwind and Font Awesome CDN links -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Inlined TailwindCSS and Custom Styles for Offline Use */
        :root {
            --teal-50: #f0fdfa; --teal-100: #ccfbf1; --teal-500: #14b8a6; --teal-600: #0d9488; --teal-700: #0f766e;
            --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb; --gray-300: #d1d5db; --gray-500: #6b7280; --gray-600: #4b5563; --gray-800: #1f2937;
            --indigo-500: #6366f1; --indigo-600: #4f46e5; --blue-600: #2563eb; --blue-700: #1d4ed8; --red-500: #ef4444; --green-500: #22c55e;
            --white: #ffffff; --black: #000000;
        }
        *, ::before, ::after { box-sizing: border-box; border-width: 0; border-style: solid; border-color: #e5e7eb; }
        html { line-height: 1.5; -webkit-text-size-adjust: 100%; -moz-tab-size: 4; tab-size: 4; font-family: 'Inter', sans-serif; }
        body { margin: 0; line-height: inherit; font-family: 'Inter', sans-serif; background-color: var(--gray-100); color: var(--gray-800); }
        .container { width: 100%; margin-right: auto; margin-left: auto; padding-right: 1rem; padding-left: 1rem; }
        @media (min-width: 768px) { .container { max-width: 768px; padding-right: 2rem; padding-left: 2rem;} }
        @media (min-width: 1024px) { .container { max-width: 1024px; } }
        .max-w-5xl { max-width: 64rem; }
        .max-w-md { max-width: 28rem; }
        .max-w-sm { max-width: 24rem; }
        .p-4 { padding: 1rem; } .p-6 { padding: 1.5rem; } .p-2 { padding: 0.5rem; } .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; } .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .mb-8 { margin-bottom: 2rem; } .mb-4 { margin-bottom: 1rem; } .mb-6 { margin-bottom: 1.5rem; } .mb-2 { margin-bottom: 0.5rem; } .mb-1 { margin-bottom: 0.25rem; }
        .mt-1 { margin-top: 0.25rem; } .mt-8 { margin-top: 2rem; }
        .mr-2 { margin-right: 0.5rem; } .ml-2 { margin-left: 0.5rem; } .mx-auto { margin-left: auto; margin-right: auto; }
        .gap-6 { gap: 1.5rem; } .gap-4 { gap: 1rem; }
        .grid { display: grid; } .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        @media (min-width: 768px) { .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
        @media (min-width: 1024px) { .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
        @media (min-width: 768px) { .md\:col-span-2 { grid-column: span 2 / span 2; } .md\:col-span-3 { grid-column: span 3 / span 3; } }
        .bg-white { background-color: var(--white); }
        .bg-gray-50 { background-color: var(--gray-50); }
        .bg-gray-100 { background-color: var(--gray-100); }
        .bg-gray-200 { background-color: var(--gray-200); }
        .bg-gray-500 { background-color: var(--gray-500); }
        .bg-teal-50 { background-color: var(--teal-50); }
        .bg-teal-500 { background-color: var(--teal-500); }
        .bg-indigo-500 { background-color: var(--indigo-500); }
        .bg-blue-600 { background-color: var(--blue-600); }
        .bg-black { background-color: var(--black); }
        .bg-opacity-50 { background-color: rgba(0,0,0,0.5); }
        .hover\:bg-gray-600:hover { background-color: var(--gray-600); }
        .hover\:bg-teal-100:hover { background-color: var(--teal-100); }
        .hover\:bg-teal-600:hover { background-color: var(--teal-600); }
        .hover\:bg-indigo-600:hover { background-color: var(--indigo-600); }
        .hover\:bg-blue-700:hover { background-color: var(--blue-700); }
        .border-gray-300 { border-color: var(--gray-300); }
        .border-t { border-top-width: 1px; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-md { border-radius: 0.375rem; }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); }
        .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1); }
        .text-center { text-align: center; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        @media (min-width: 640px) { .sm\:text-3xl { font-size: 1.875rem; line-height: 2.25rem; } }
        @media (min-width: 768px) { .md\:text-4xl { font-size: 2.25rem; line-height: 2.5rem; } }
        .font-bold { font-weight: 700; }
        .text-teal-600 { color: var(--teal-600); }
        .text-gray-500 { color: var(--gray-500); }
        .text-gray-900 { color: #111827; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .font-medium { font-weight: 500; }
        .text-gray-600 { color: var(--gray-600); }
        .w-full { width: 100%; }
        @media (min-width: 640px) { .sm\:w-auto { width: auto; } }
        input, button { font-family: inherit; font-size: 100%; margin: 0; padding: 0; line-height: inherit; color: inherit; }
        input[type="text"], input[type="tel"], input[type="date"], input[type="number"] { padding: 0.5rem; border-width: 1px; border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); }
        input[type="radio"] { height: 1rem; width: 1rem; }
        .focus\:ring-teal-500:focus { --tw-ring-color: var(--teal-500); }
        .focus\:border-teal-500:focus { border-color: var(--teal-500); }
        .transition { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .overflow-x-auto { overflow-x: auto; }
        .uppercase { text-transform: uppercase; }
        .text-white { color: var(--white); }
        .font-semibold { font-weight: 600; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        @media (min-width: 640px) { .sm\:flex-row { flex-direction: row; } }
        .items-center { align-items: center; }
        .justify-end { justify-content: flex-end; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .flex-wrap { flex-wrap: wrap; }
        .pt-6 { padding-top: 1.5rem; }
        .fixed { position: fixed; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        .z-50 { z-index: 50; }
        .hidden { display: none; }
        .transform { transform: translate(0, 0) rotate(0) skewX(0) skewY(0) scaleX(1) scaleY(1); }
        .scale-95 { transform: scale(0.95); }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .hover\:text-gray-800:hover { color: var(--gray-800); }
        .min-h-\[256px\] { min-height: 256px; }
        .bottom-5 { bottom: 1.25rem; }
        .right-5 { right: 1.25rem; }
        .translate-y-20 { transform: translateY(5rem); }
        .opacity-0 { opacity: 0; }
        .text-red-500 { color: var(--red-500); }
        .hover\:text-red-700:hover { color: #b91c1c; }
        .relative { position: relative; }
        .bg-transparent { background-color: transparent; }
        .border-b-2 { border-bottom-width: 2px; }
        .focus\:outline-none:focus { outline: 2px solid transparent; outline-offset: 2px; }
        .w-24 { width: 6rem; }
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .file\:mr-4::file-selector-button { margin-right: 1rem; }
        .file\:py-2::file-selector-button { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .file\:px-4::file-selector-button { padding-left: 1rem; padding-right: 1rem; }
        .file\:rounded-md::file-selector-button { border-radius: 0.375rem; }
        .file\:border-0::file-selector-button { border-width: 0; }
        .file\:text-sm::file-selector-button { font-size: 0.875rem; line-height: 1.25rem; }
        .file\:font-semibold::file-selector-button { font-weight: 600; }
        .file\:bg-teal-50::file-selector-button { background-color: var(--teal-50); }
        .file\:text-teal-700::file-selector-button { color: var(--teal-700); }
        .hover\:file\:bg-teal-100:hover::file-selector-button { background-color: var(--teal-100); }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        #toast { transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out; }
        .autocomplete-suggestions { position: absolute; border: 1px solid #ddd; background-color: white; z-index: 1000; max-height: 150px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .autocomplete-suggestion { padding: 8px; cursor: pointer; }
        .autocomplete-suggestion:hover { background-color: #f0f0f0; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="bg-white rounded-lg shadow-md p-6 mb-8 text-center">
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-teal-600">Sahyog Medical</h1>
            <p class="text-gray-500 mt-1">Easy Billing Data Entry</p>
        </header>

        <main class="bg-white rounded-lg shadow-md p-4 sm:p-6 md:p-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div>
                    <label for="customerName" class="block text-sm font-medium text-gray-600 mb-1">Customer Name</label>
                    <input type="text" id="customerName" class="w-full bg-gray-50 border-gray-300 rounded-md shadow-sm p-2 focus:ring-teal-500 focus:border-teal-500 transition" placeholder="Walk-in Customer">
                </div>
                <div>
                    <label for="phoneNumber" class="block text-sm font-medium text-gray-600 mb-1">Phone Number</label>
                    <input type="tel" id="phoneNumber" class="w-full bg-gray-50 border-gray-300 rounded-md shadow-sm p-2 focus:ring-teal-500 focus:border-teal-500 transition" placeholder="e.g., 9876543210">
                </div>
                <div>
                    <label for="doctorName" class="block text-sm font-medium text-gray-600 mb-1">Doctor's Name</label>
                    <input type="text" id="doctorName" class="w-full bg-gray-50 border-gray-300 rounded-md shadow-sm p-2 focus:ring-teal-500 focus:border-teal-500 transition" placeholder="Self">
                </div>
                <div>
                    <label for="billDate" class="block text-sm font-medium text-gray-600 mb-1">Date</label>
                    <input type="date" id="billDate" class="w-full bg-gray-50 border-gray-300 rounded-md shadow-sm p-2 focus:ring-teal-500 focus:border-teal-500 transition">
                </div>
                <div class="md:col-span-2">
                    <label for="customerAddress" class="block text-sm font-medium text-gray-600 mb-1">Customer Address</label>
                    <input type="text" id="customerAddress" class="w-full bg-gray-50 border-gray-300 rounded-md shadow-sm p-2 focus:ring-teal-500 focus:border-teal-500 transition" placeholder="City/Town">
                </div>
                <div class="md:col-span-2">
                    <label for="doctorsPrescriptionFile" class="block text-sm font-medium text-gray-600 mb-1">Doctor's Prescription</label>
                    <input type="file" id="doctorsPrescriptionFile" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-600 mb-2">Bill Type</label>
                    <div class="flex items-center gap-6">
                        <div class="flex items-center">
                            <input id="rx" name="billType" type="radio" value="Rx" checked class="h-4 w-4 border-gray-300 text-teal-600 focus:ring-teal-500">
                            <label for="rx" class="ml-2 block text-sm text-gray-900">Rx (Normal)</label>
                        </div>
                        <div class="flex items-center">
                            <input id="nrx" name="billType" type="radio" value="NRx" class="h-4 w-4 border-gray-300 text-teal-600 focus:ring-teal-500">
                            <label for="nrx" class="ml-2 block text-sm text-gray-900">NRx (Special - Colored)</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-8 overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-200 text-gray-600 uppercase">
                        <tr>
                            <th class="px-2 py-3 sm:p-3">Medicine Name</th>
                            <th class="px-2 py-3 sm:p-3">Batch No.</th>
                            <th class="px-2 py-3 sm:p-3">Qty</th>
                            <th class="px-2 py-3 sm:p-3">Photo</th>
                            <th class="px-2 py-3 sm:p-3 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="items-table-body"></tbody>
                </table>
            </div>

            <!-- Mobile-friendly buttons -->
            <div class="flex flex-col sm:flex-row sm:justify-between items-center mb-8 gap-4">
                <button id="add-item-btn" class="w-full sm:w-auto bg-teal-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-teal-600 transition shadow-sm flex items-center justify-center">
                    <svg class="mr-2" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg> Add Item
                </button>
                <button id="generate-qr-btn" class="w-full sm:w-auto bg-indigo-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-600 transition shadow-sm flex items-center justify-center">
                    <svg class="mr-2" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 1.5A1.5 1.5 0 0 0 0 3v10a1.5 1.5 0 0 0 1.5 1.5h13A1.5 1.5 0 0 0 16 13V3a1.5 1.5 0 0 0-1.5-1.5h-13zM2 6h12v7H2V6zm1-4h2v2H3V2zm4 0h2v2H7V2zM2 2h2v2H2V2zm5 0h2v2H7V2zM3 3h1v1H3V3zm5 0h1v1H8V3z"/></svg> Generate Payment QR
                </button>
            </div>

            <div class="flex flex-col sm:flex-row sm:justify-end gap-4 mt-8 border-t pt-6">
                <button id="clear-form-btn" class="w-full sm:w-auto bg-gray-500 text-white font-semibold py-2 px-6 rounded-md hover:bg-gray-600 transition shadow-sm">Clear</button>
                <button id="save-bill-btn" class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-blue-700 transition shadow-sm">Save Data</button>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="dataModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md transform scale-95 text-center p-6">
            <svg class="mx-auto text-green-500 w-12 h-12 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">Success!</h3>
            <p class="text-gray-600 mb-6">Data sent to Google Sheet.</p>
            <button id="okModalBtn" class="bg-teal-500 text-white font-semibold py-2 px-6 rounded-md hover:bg-teal-600 transition shadow-sm">OK</button>
        </div>
    </div>
    
    <div id="qrModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm transform scale-95 p-6">
            <div class="flex justify-between items-center mb-4">
                 <h3 class="text-lg font-semibold text-gray-800">Generate UPI QR Code</h3>
                 <button id="closeQrModalBtn" class="text-gray-500 hover:text-gray-800"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg></button>
            </div>
            <div>
                <label for="amountInput" class="block text-sm font-medium text-gray-600 mb-1">Enter Amount (â‚¹)</label>
                <input type="number" id="amountInput" class="w-full bg-gray-50 border-gray-300 rounded-md shadow-sm p-2 mb-4" placeholder="e.g., 500">
                <button id="createQrBtn" class="w-full bg-teal-500 text-white font-semibold py-2 rounded-md hover:bg-teal-600 transition shadow-sm mb-4">Generate QR</button>
                <div id="qrcode" class="flex justify-center items-center bg-gray-100 p-4 rounded-md min-h-[256px]">
                    <p class="text-gray-500">QR code will appear here</p>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 bg-red-500 text-white py-3 px-6 rounded-lg shadow-lg transform translate-y-20 opacity-0">
        <p id="toastMessage"></p>
    </div>
    
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzUPAGg3CCWlNW0qFS_mHOcTshodzODJ225OHXRmO2tNupkIAkBdpZUi_Y2EG9VrWu3qw/exec';
        const UPI_ID = "mab.037325040420024@axisbank";
        const medicineList = [ "Crocin Advance", "Calpol 500mg", "Dolo 650mg", "Paracetamol 500mg", "Combiflam", "Sumo Tablet", "ORS Powder", "Electral Powder", "Digene Tablet", "Gelusil MPS", "Omez 20mg", "Pantop DSR", "Allegra 120mg", "Cetirizine 10mg", "Avil 25mg", "Benadryl Syrup", "Vicks Action 500", "Band-Aid", "Dettol", "Savlon", "Betadine Ointment", "Soframycin Skin Cream", "Moov Spray", "Volini Gel" ];

        const billDateInput = document.getElementById('billDate');
        const addItemBtn = document.getElementById('add-item-btn');
        const itemsTableBody = document.getElementById('items-table-body');
        const saveBillBtn = document.getElementById('save-bill-btn');
        const clearFormBtn = document.getElementById('clear-form-btn');
        const generateQrBtn = document.getElementById('generate-qr-btn');
        const dataModal = document.getElementById('dataModal');
        const okModalBtn = document.getElementById('okModalBtn');
        const qrModal = document.getElementById('qrModal');
        const closeQrModalBtn = document.getElementById('closeQrModalBtn');
        const createQrBtn = document.getElementById('createQrBtn');
        const amountInput = document.getElementById('amountInput');
        const qrcodeContainer = document.getElementById('qrcode');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');

        document.addEventListener('DOMContentLoaded', () => {
            billDateInput.value = new Date().toISOString().split('T')[0];
            addNewItemRow();
        });

        addItemBtn.addEventListener('click', addNewItemRow);
        clearFormBtn.addEventListener('click', () => clearForm(true));
        saveBillBtn.addEventListener('click', saveData);
        itemsTableBody.addEventListener('keyup', (e) => {
             if (e.target.classList.contains('medicine-input')) {
                showAutocomplete(e.target);
            }
        });
        itemsTableBody.addEventListener('click', (e) => {
            const removeItemBtn = e.target.closest('.remove-item-btn');
            if (removeItemBtn) {
                if (itemsTableBody.querySelectorAll('tr').length > 1) {
                    removeItemBtn.closest('tr').remove();
                }
            }
        });
        document.addEventListener('click', (e) => {
             if (!e.target.classList.contains('medicine-input')) {
                const suggestions = document.querySelector('.autocomplete-suggestions');
                if(suggestions) suggestions.remove();
            }
        });
        
        okModalBtn.addEventListener('click', () => {
            toggleModal(dataModal, false);
            clearForm(true);
        });
        
        generateQrBtn.addEventListener('click', () => toggleModal(qrModal, true));
        closeQrModalBtn.addEventListener('click', () => toggleModal(qrModal, false));
        createQrBtn.addEventListener('click', () => {
             const amount = amountInput.value;
             if (UPI_ID === "" || UPI_ID.includes("your-upi-id-here")) {
                 qrcodeContainer.innerHTML = `<p class="text-red-500">Please set your UPI ID in the HTML file first.</p>`;
                 return;
             }
             if(amount && amount > 0){
                 qrcodeContainer.innerHTML = '';
                 const upiUrl = `upi://pay?pa=${UPI_ID}&pn=Sahyog%20Medical&am=${amount}&cu=INR`;
                 new QRCode(qrcodeContainer, { text: upiUrl, width: 256, height: 256 });
             } else {
                 qrcodeContainer.innerHTML = `<p class="text-gray-500">Please enter a valid amount.</p>`;
             }
        });

        async function saveData() {
            saveBillBtn.disabled = true;
            saveBillBtn.textContent = 'Saving...';
            try {
                const doctorsPrescriptionInput = document.getElementById('doctorsPrescriptionFile');
                const billType = document.querySelector('input[name="billType"]:checked').value;

                const billData = {
                    billDate: billDateInput.value,
                    customerName: document.getElementById('customerName').value || 'Walk-in',
                    phoneNumber: document.getElementById('phoneNumber').value,
                    customerAddress: document.getElementById('customerAddress').value,
                    doctorName: document.getElementById('doctorName').value || 'Self',
                    billType: billType,
                    doctorsPrescriptionFile: null,
                    items: [],
                };
                if (doctorsPrescriptionInput.files.length > 0) {
                    const file = doctorsPrescriptionInput.files[0];
                    billData.doctorsPrescriptionFile = { name: file.name, mimeType: file.type, data: await fileToBase64(file) };
                }
                const rows = itemsTableBody.querySelectorAll('tr');
                for (const row of rows) {
                    const inputs = row.querySelectorAll('input');
                    const medicineName = inputs[0].value;
                    if (medicineName.trim() !== "") {
                        let medicinePhotoFile = null;
                        if(inputs[3].files.length > 0){
                            const file = inputs[3].files[0];
                            medicinePhotoFile = { name: file.name, mimeType: file.type, data: await fileToBase64(file) };
                        }
                        billData.items.push({ 
                            medicineName, 
                            batchNo: inputs[1].value, 
                            quantity: parseFloat(inputs[2].value) || 0,
                            medicinePhotoFile 
                        });
                    }
                }
                if (billData.items.length === 0) throw new Error("Please add at least one medicine to save.");
                const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(billData) });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (result.status === 'success') {
                    toggleModal(dataModal, true);
                } else {
                    throw new Error(result.message || 'Unknown error from script.');
                }
            } catch (error) {
                console.error("Error sending data:", error);
                showToast(`Failed to save: ${error.message}`);
            } finally {
                saveBillBtn.disabled = false;
                saveBillBtn.textContent = 'Save Data';
            }
        }
        
        function addNewItemRow() {
            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-gray-50';
            row.innerHTML = `
                <td class="p-2 relative">
                    <input type="text" class="medicine-input w-full bg-transparent border-b-2 border-gray-200 focus:outline-none focus:border-teal-500" placeholder="Type Medicine Name">
                </td>
                <td class="p-2"><input type="text" class="w-full bg-transparent border-b-2 border-gray-200 focus:outline-none focus:border-teal-500" placeholder="Batch"></td>
                <td class="p-2"><input type="number" min="0" class="w-24 bg-transparent border-b-2 border-gray-200 focus:outline-none focus:border-teal-500" placeholder="0"></td>
                <td class="p-2"><input type="file" class="text-xs w-full"></td>
                <td class="p-2 text-center">
                    <button class="remove-item-btn text-red-500 hover:text-red-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                    </button>
                </td>
            `;
            itemsTableBody.appendChild(row);
            row.querySelector('input').focus();
        }
        
        function clearForm(clearCustomer) {
            if (clearCustomer) {
                document.getElementById('customerName').value = '';
                document.getElementById('phoneNumber').value = '';
                document.getElementById('customerAddress').value = '';
                document.getElementById('doctorName').value = '';
                document.getElementById('rx').checked = true;
            }
            document.getElementById('doctorsPrescriptionFile').value = '';
            itemsTableBody.innerHTML = '';
            addNewItemRow();
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        function showToast(message) {
            toastMessage.textContent = message;
            toast.classList.remove('opacity-0', 'translate-y-20');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-20');
            }, 3000);
        }

        function toggleModal(modal, show) {
            const modalContent = modal.querySelector('.modal-content');
            if (show) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    if(modalContent) modalContent.classList.remove('scale-95');
                }, 10);
            } else {
                if(modalContent) modalContent.classList.add('scale-95');
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        function showAutocomplete(inputElement) {
            const existingSuggestions = document.querySelector('.autocomplete-suggestions');
            if (existingSuggestions) existingSuggestions.remove();
            const query = inputElement.value.toLowerCase();
            if (query.length < 2) return;
            const suggestions = filterMedicines(query);
            if (suggestions.length === 0) return;
            const suggestionsContainer = document.createElement('div');
            suggestionsContainer.className = 'autocomplete-suggestions';
            suggestions.forEach(suggestion => {
                const suggestionEl = document.createElement('div');
                suggestionEl.className = 'autocomplete-suggestion';
                suggestionEl.textContent = suggestion;
                suggestionEl.addEventListener('click', () => {
                    inputElement.value = suggestion;
                    suggestionsContainer.remove();
                });
                suggestionsContainer.appendChild(suggestionEl);
            });
            inputElement.parentNode.appendChild(suggestionsContainer);
        }

        function filterMedicines(query) {
            return medicineList.filter(med => med.toLowerCase().includes(query)).slice(0, 5);
        }
    </script>
</body>
</html>

